-- *********************************************************************
-- Update Database Script
-- *********************************************************************
-- Change Log: ./createPostgreSqlSchema.xml
-- Ran at: 12/04/22, 3:22 PM
-- Against: postgres@jdbc:postgresql://127.0.0.1:5432/crestelsmngt7100
-- Liquibase version: 3.4.2
-- *********************************************************************

-- Create Database Lock Table
CREATE TABLE public.databasechangeloglock (ID INT NOT NULL, LOCKED BOOLEAN NOT NULL, LOCKGRANTED TIMESTAMP WITHOUT TIME ZONE, LOCKEDBY VARCHAR(255), CONSTRAINT PK_DATABASECHANGELOGLOCK PRIMARY KEY (ID));

-- Initialize Database Lock Table
DELETE FROM public.databasechangeloglock;

INSERT INTO public.databasechangeloglock (ID, LOCKED) VALUES (1, FALSE);

-- Lock Database
UPDATE public.databasechangeloglock SET LOCKED = TRUE, LOCKEDBY = '2401:4900:4ffa:3f31:f6bf:7014:129d:bc6c%wlo1 (2401:4900:4ffa:3f31:f6bf:7014:129d:bc6c%wlo1)', LOCKGRANTED = '2022-04-12 15:22:18.280' WHERE ID = 1 AND LOCKED = FALSE;

-- Create Database Change Log Table
CREATE TABLE public.databasechangelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP WITHOUT TIME ZONE NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255));

-- Changeset ./createPostgreSqlSchema.xml::NP40000000001::elitecore
-- create schema.
CREATE SCHEMA crestelsmngt7100 AUTHORIZATION crestelsmngt7100;

INSERT INTO public.databasechangelog (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE) VALUES ('NP40000000001', 'elitecore', './createPostgreSqlSchema.xml', NOW(), 1, '7:e54beb1155f65c8ad4a4030ff403b10d', 'sql', 'create schema.', 'EXECUTED', NULL, NULL, '3.4.2');

-- Changeset ./createPostgreSqlSchema.xml::NP40000000002::elitecore
-- give ownership to user
ALTER SCHEMA crestelsmngt7100 OWNER TO crestelsmngt7100;

INSERT INTO public.databasechangelog (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE) VALUES ('NP40000000002', 'elitecore', './createPostgreSqlSchema.xml', NOW(), 2, '7:5758070708ecf71a380f2d741b68e7aa', 'sql', 'give ownership to user', 'EXECUTED', NULL, NULL, '3.4.2');

-- Changeset ./createPostgreSqlSchema.xml::NP40000000003::elitecore
-- Migrate Public tables to Private Schema
DO $$ DECLARE     
   public_tables_list record;
   public_sequence_list record;     
   public_view_list record;
   private_schema_name text;
   temp_sql text;
BEGIN 
	SELECT schema_name INTO private_schema_name FROM information_schema.schemata WHERE schema_name LIKE 'crestelsm%';	
	raise notice ' Migration Schema Name %', private_schema_name;
	FOR public_tables_list IN SELECT tablename FROM pg_tables WHERE schemaname = 'public'
	LOOP
		CASE public_tables_list.tablename
	 	WHEN 'databasechangeloglock' THEN
	    	temp_sql := 'CREATE TABLE ' || private_schema_name || '.databasechangeloglock AS SELECT * FROM public.databasechangeloglock;';
	    	EXECUTE temp_sql;
	    	temp_sql := 'ALTER TABLE ' || private_schema_name || '.databasechangeloglock OWNER TO ' || private_schema_name ||';';
	    	EXECUTE temp_sql;
	    	temp_sql := 'UPDATE '|| private_schema_name || '.databasechangeloglock SET locked =''false'';';
	    	EXECUTE temp_sql;
	 	WHEN 'databasechangelog' THEN
	    	temp_sql := 'CREATE TABLE '|| private_schema_name || '.databasechangelog AS SELECT * FROM public.databasechangelog;';
	    	EXECUTE temp_sql;
	    	temp_sql := 'ALTER TABLE '|| private_schema_name || '.databasechangelog  OWNER TO ' || private_schema_name || ';';
	    	EXECUTE temp_sql;	    	
	 	ELSE
	    	temp_sql := 'ALTER TABLE public.' || quote_ident(public_tables_list.tablename) || ' SET SCHEMA ' || private_schema_name || ';';
	    	EXECUTE temp_sql;
			temp_sql := 'ALTER TABLE ' || private_schema_name || '.' || quote_ident(public_tables_list.tablename) || ' OWNER TO ' || private_schema_name || ';';
			EXECUTE temp_sql;
	 	END CASE;
 	END LOOP;
 	FOR public_view_list IN SELECT viewname FROM pg_catalog.pg_views WHERE schemaname NOT IN ('pg_catalog', 'information_schema') AND schemaname = 'public'
    LOOP
        temp_sql := 'ALTER VIEW public.' || quote_ident(public_view_list.viewname) || ' SET SCHEMA ' || private_schema_name || ';';		
		EXECUTE temp_sql;
		temp_sql := 'ALTER VIEW ' || private_schema_name || '.' || quote_ident(public_view_list.viewname) || ' OWNER TO ' || private_schema_name || ';';
		EXECUTE temp_sql;
    END LOOP;
    FOR public_sequence_list IN SELECT sequence_name FROM information_schema.sequences WHERE sequence_schema='public'
    LOOP
        temp_sql := 'ALTER SEQUENCE public.' || quote_ident(public_sequence_list.sequence_name) || ' SET SCHEMA ' || private_schema_name || ';';		
		EXECUTE temp_sql;
		temp_sql := 'ALTER SEQUENCE ' || private_schema_name || '.' || quote_ident(public_sequence_list.sequence_name) || ' OWNER TO ' || private_schema_name || ';';
		EXECUTE temp_sql;
    END LOOP;

END$$//

INSERT INTO public.databasechangelog (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE) VALUES ('NP40000000003', 'elitecore', './createPostgreSqlSchema.xml', NOW(), 3, '7:e1ef949a4ae44ead3c40576b93d7b942', 'sqlFile', 'Migrate Public tables to Private Schema', 'EXECUTED', NULL, NULL, '3.4.2');

-- Release Database Lock
UPDATE public.databasechangeloglock SET LOCKED = FALSE, LOCKEDBY = NULL, LOCKGRANTED = NULL WHERE ID = 1;

